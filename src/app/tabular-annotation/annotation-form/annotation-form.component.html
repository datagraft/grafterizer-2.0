<div id="annotation-component" class="card">
  <form class="compact" [formGroup]="annotationForm" (ngSubmit)="onSubmit()" autocomplete="off">
    <div class="card-header">
      <clr-tooltip *ngIf="annotationForm.invalid || subjectValuesTypeValidator()" class="pull-right">
        <clr-icon clrTooltipTrigger shape="error-standard" size="20" class="is-solid is-danger"></clr-icon>
        <clr-tooltip-content clrPosition="left" clrSize="sm" *clrIfOpen>
          <span>This annotation is not valid</span>
        </clr-tooltip-content>
      </clr-tooltip>
      <clr-tooltip *ngIf="!submitted && !(annotationForm.invalid || subjectValuesTypeValidator())" class="pull-right">
        <clr-icon clrTooltipTrigger shape="warning-standard" size="20" class="is-solid is-warning"></clr-icon>
        <clr-tooltip-content clrPosition="left" clrSize="sm" *clrIfOpen>
          <span>This annotation is not submitted</span>
        </clr-tooltip-content>
      </clr-tooltip>
      <clr-tooltip *ngIf="submitted" class="pull-right">
        <clr-icon clrTooltipTrigger shape="success-standard" size="20" class="is-solid is-success"></clr-icon>
        <clr-tooltip-content clrPosition="left" clrSize="sm" *clrIfOpen>
          <span>This column is properly annotated</span>
        </clr-tooltip-content>
      </clr-tooltip>
      <clr-tooltip clrTooltipTrigger class="pull-right">
        <span class="label" [ngClass]="{'inverse': isSubject}">S</span>
        <span class="label" [ngClass]="{'inverse': isObject}">O</span>
        <clr-tooltip-content clrPosition="left" clrSize="md" *clrIfOpen>
          <span>The roles are detected based on the relationships.</span>
        </clr-tooltip-content>
      </clr-tooltip>
      Name: {{header}}
    </div>
    <!-- Column information -->
    <div class="card-block">
      <div class="card-title">
        Column Information
      </div>
      <div class="card-text">
        <div formGroupName="columnInfo">
          <div class="form-group">
            <label class="required">Column values type</label>
            <div class="btn-group">
              <div class="radio btn btn-sm" [ngClass]="{'btn-danger': subjectValuesTypeValidator()}"
                   *ngFor="let columnValuesType of availableColumnValuesTypes; let i = index">
                <input type="radio" name="{{ header }}.columnDatatype"
                       id="{{ header }}.columnValuesType{{i}}"
                       (click)="changeValuesType(columnValuesType)">
                <label for="{{ header }}.columnValuesType{{i}}">{{columnValuesType}}</label>
              </div>
            </div>
            <clr-tooltip *ngIf="subjectValuesTypeValidator()">
              <clr-icon clrTooltipTrigger shape="error-standard" size="20" class="is-solid is-danger"></clr-icon>
              <clr-tooltip-content clrPosition="left" clrSize="sm" *clrIfOpen>
                <span>A subject column must be of type URI.</span>
              </clr-tooltip-content>
            </clr-tooltip>
          </div>
          <div class="form-group" *ngIf="displayType">
            <label class="required" for="columnType">Column Type</label>
            <label for="columnType"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.get('columnInfo.columnType').invalid
                      && (annotationForm.get('columnInfo.columnType').dirty || annotationForm.get('columnInfo.columnType').touched)
                      || annotationForm.hasError('invalidColumnType')"
                   auto-complete
                   [source]="typeSuggestions"
                   [list-formatter]="autocompleteListFormatter"
                   value-property-name="suggestion"
                   display-property-name="suggestion"
                   select-value-of="suggestion"
                   loading-text="Querying ABSTAT..."
                   (valueChanged)="annotationForm.get('columnInfo.columnType').setValue($event)"
                   min-chars="2">
              <input id="columnType"
                     type="text"
                     formControlName="columnType"
                     placeholder="Insert column type"/>
              <span *ngIf="annotationForm.hasError('invalidColumnType')"
                    class="tooltip-content"> {{annotationForm.errors['invalidColumnType'].errorMessage}}</span>
              <span *ngIf="annotationForm.get('columnInfo.columnType').hasError('pattern')"
                    class="tooltip-content"> Column type must be a valid URL.</span>
            </label>
          </div>
          <div class="form-group" *ngIf="displayDatatype">
            <label class="required" for="columnDatatype">Column datatype: </label>
            <div class="select">
              <select id="columnDatatype"
                      name="columnDatatype"
                      formControlName="columnDatatype"
                      (change)="changeDatatype($event.target.value)">
                <option *ngFor="let datatype of availableDatatypes" [value]="datatype">{{datatype}}</option>
              </select>
            </div>
          </div>
          <div class="form-group" *ngIf="displayCustomDatatype">
            <label for="customDatatype" class="required">Custom datatype</label>
            <label for="customDatatype"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.get('columnInfo.customDatatype').invalid
                      && (annotationForm.get('columnInfo.customDatatype').dirty || annotationForm.get('columnInfo.customDatatype').touched) ||
                      annotationForm.hasError('invalidCustomDatatype')">
              <input id="customDatatype" type="text"
                     formControlName="customDatatype">
              <span class="tooltip-content" *ngIf="annotationForm.hasError('invalidCustomDatatype')">
                    {{annotationForm.errors['invalidCustomDatatype'].errorMessage}}
              </span>
              <span *ngIf="annotationForm.get('columnInfo.customDatatype').hasError('pattern')"
                    class="tooltip-content"> Custom datatype must be a valid URL.</span>
            </label>
          </div>
          <div class="form-group" *ngIf="displayDatatype && displayLangTag">
            <label for="langTag" class="required">Language tag</label>
            <label for="langTag"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.hasError('invalidLangTag')">
              <input id="langTag" type="text"
                     formControlName="langTag">
              <span class="tooltip-content" *ngIf="annotationForm.hasError('invalidLangTag')">
                    {{annotationForm.errors['invalidLangTag'].errorMessage}}
              </span>
            </label>
          </div>
          <div class="form-group" *ngIf="displayURIprefix">
            <label for="urifyPrefix">
              URIfy with prefix:
              <clr-tooltip>
                <clr-icon clrTooltipTrigger shape="info-circle" size="20" class="is-solid"></clr-icon>
                <clr-tooltip-content clrPosition="left" clrSize="sm" *clrIfOpen>
                  <span>URIfy column values using this prefix. If empty, column values will be used as URIs.</span>
                </clr-tooltip-content>
              </clr-tooltip>
            </label>
            <label for="urifyPrefix"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.get('columnInfo.urifyPrefix').invalid
                      && (annotationForm.get('columnInfo.urifyPrefix').dirty ||
                      annotationForm.get('columnInfo.urifyPrefix').touched)">
              <input id="urifyPrefix"
                     type="text"
                     formControlName="urifyPrefix"
                     placeholder="Insert a URI prefix"/>
              <span *ngIf="annotationForm.get('columnInfo.urifyPrefix').hasError('pattern')"
                    class="tooltip-content"> This prefix is not valid.</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <!-- Relationship -->
    <div class="card-block">
      <div class="card-title">
        Relationships
      </div>
      <div class="card-text">
        <div formGroupName="relationship">
          <div class="form-group">
            <label for="subject">Source column</label>
            <label for="subject"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.get('relationship.subject').invalid
                      && (annotationForm.get('relationship.subject').dirty || annotationForm.get('relationship.subject').touched)
                      || annotationForm.hasError('invalidSubject')"
                   auto-complete
                   [source]="allowedSources"
                   (valueChanged)="changeSourceColumn($event)">
              <input id="subject" type="text"
                     formControlName="subject"
                     placeholder="Choose a source column">
              <span *ngIf="annotationForm.get('relationship.subject').hasError('invalidSubject')"
                    class="tooltip-content">{{annotationForm.get('relationship.subject').errors['invalidSubject'].errorMessage}}</span>
              <span *ngIf="annotationForm.hasError('invalidSubject')"
                    class="tooltip-content">{{annotationForm.errors['invalidSubject'].errorMessage}}</span>
            </label>
          </div>
          <div class="form-group">
            <label for="property">Property</label>
            <label for="property"
                   aria-haspopup="true"
                   role="tooltip"
                   class="tooltip tooltip-validation tooltip-sm"
                   [class.invalid]="annotationForm.get('relationship.property').invalid
                          && (annotationForm.get('relationship.property').dirty ||
                          annotationForm.get('relationship.property').touched)
                          || annotationForm.hasError('invalidProperty')"
                   auto-complete
                   [source]="propertySuggestions"
                   [list-formatter]="autocompleteListFormatter"
                   value-property-name="suggestion"
                   display-property-name="suggestion"
                   select-value-of="suggestion"
                   loading-text="Querying ABSTAT..."
                   (valueChanged)="annotationForm.get('relationship.property').setValue($event)"
                   min-chars="2">
              <input id="property" type="text"
                     formControlName="property"
                     placeholder="Insert relationship property">
              <span *ngIf="annotationForm.get('relationship.property').hasError('pattern')"
                    class="tooltip-content"> The property must be a valid URL. </span>
              <span *ngIf="annotationForm.hasError('invalidProperty')"
                    class="tooltip-content"> {{annotationForm.errors['invalidProperty'].errorMessage}}</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <button class="btn btn-sm btn-link"
              type="submit"
              [disabled]="annotationForm.invalid ||
              subjectValuesTypeValidator() ||
              submitted">Annotate</button>
      <a class="btn btn-sm btn-link" (click)="deleteAnnotation()">Delete</a>
    </div>
  </form>
</div>
